<!doctype html>
<html>
	<head>
		<script src='w3color.js'></script>
		<meta charset="utf-8"/>
		<style>
td, tr, table {border: solid 1px black;}
td {width: 60px; height: 25px; }
.distance-matrix input, .distance-matrix td, .distance-matrix th {width: 40px; height: 40px; }
		</style>
		<title>Couleurs</title>
	</head>
	<body>
		<script src="jquery-3.3.1.js"></script>
		<script src="labColor.js" ></script>
		<script src="diff.js" ></script>
		<script>
		Number.prototype.toFixedDown = function(digits) {
			var re = new RegExp("(\\d+\\.\\d{" + digits + "})(\\d)"),
				m = this.toString().match(re);
			return m ? parseFloat(m[1]) : this.valueOf();
		};
		function getColors() {
			var colors = [];
			$("#color-tbody tr").each(function(index, element){
				colors.push({
					before:$(element).find(".color-input-before").first().val(),
					after:$(element).find(".color-input-after").first().val()
				});
			});
			return colors;
		}
		function w3colorDistance(colorA, colorB) {
			var aArrayLab = RGBtoLAB(colorA.red, colorA.green, colorA.blue);
			var bArrayLab = RGBtoLAB(colorB.red, colorB.green, colorB.blue);
			return ciede2000(
				{
					L:aArrayLab[0],
					a:aArrayLab[1],
					b:aArrayLab[2]
				},
				{
					L:bArrayLab[0],
					a:bArrayLab[1],
					b:bArrayLab[2]
				}
			);
		}
		function adaptColorBackground(jQueryElement,value){
			console.log(jQueryElement);
			console.log(value);
			if(!value.startsWith("#"))
			{
				value = "#" + value;
			}
			jQueryElement.css("background",value);
		};
		function supprimerLigne(element) {
			$(element).parents('tr').first().remove();
		}
		function getColorLineHtmlTag(colorBefore,colorAfter,distanceToRef) {
			return '<tr><td><button type="button" onclick="supprimerLigne(this);">Supprimer</button></td><td><input type="text" class="color-input-before-code" value="'+colorBefore+'" onchange="copyValTo(this,$(this).parents(\'tr\').find(\'td input.color-input-before\'));"/></td><td><input type="color" class="color-input-before" value="'+colorBefore+'" onchange="copyValTo(this,$(this).parents(\'tr\').find(\'td input.color-input-before-code\'));"/></td><td><input type="color" class="color-input-after" value="'+colorAfter+'" onchange="copyValTo(this,$(this).parents(\'tr\').find(\'td input.color-input-after-code\'));"/></td><td><input type="text" class="color-input-after-code" value="'+colorAfter+'" onchange="copyValTo(this,$(this).parents(\'tr\').find(\'td input.color-input-after\'));"/></td><td class="distanceToRef">'+distanceToRef+'</td></tr>';
		}
		function ajouterCouleurs(){
			var colors = $("#new-colors-input").val().split("\n");
			var tbody = $("#color-tbody");
			tbody.empty();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				color = color.trim();
				if(color) {
					tbody.append(getColorLineHtmlTag(color,color,""));
				}
			}
		}
		function sortingColorsLab(){
			var colors = getColors();
			var referenceW3Color = w3color($("#color-sorting-lab").val());
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				color.distanceToRef = w3colorDistance(w3color(color.before), referenceW3Color);
				console.log(color.distanceToRef);
			}
			colors = colors.sort(function(a, b){
				return (a.distanceToRef - b.distanceToRef);
			});
			var tbody = $("#color-tbody");
			tbody.empty();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color) {
					tbody.append(getColorLineHtmlTag(color.before,color.after,color.distanceToRef));
				}
			}
		}
		function sortingColorsCustom(){
			var colors = getColors();
			var referenceW3Color = w3color($("#color-sorting-custom").val());
			var refColorObject = referenceW3Color.toHsl();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				var colorObject = w3color(color.before).toHsl();
				var hDist = Math.abs(colorObject.h-refColorObject.h);
				if( hDist > 180 ) {
					hDist = 360 - hDist;
				}
				color.distanceToRef = Math.pow( Math.pow(hDist,2) + Math.pow((colorObject.s - refColorObject.s)*100,2) + Math.pow((colorObject.l - refColorObject.l)*100,2),0.5);
				console.log(color.distanceToRef);
			}
			colors = colors.sort(function(a, b){
				return (a.distanceToRef - b.distanceToRef);
			});
			var tbody = $("#color-tbody");
			tbody.empty();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color) {
					tbody.append(getColorLineHtmlTag(color.before,color.after,color.distanceToRef));
				}
			}
		}
		function buildDistanceLabMatrix(colors){
			var distanceGrid = {};
			var distanceList = [];
			for (var colorIndex1 = 0; colorIndex1 < colors.length; colorIndex1++) {
				var color1 = colors[colorIndex1];
				if(!(color1.before in distanceGrid)) {
					distanceGrid[color1.before] = {};
				}
				for (var colorIndex2 = colorIndex1; colorIndex2 < colors.length; colorIndex2++) {
					var color2 = colors[colorIndex2];
					if(!(color2.before in distanceGrid)) {
						distanceGrid[color2.before] = {};
					}
					$('#processing-progress').text(colorIndex1 + '/' + colorIndex2 + '/' + colors.length );
					var distance = w3colorDistance(w3color(color1.before), w3color(color2.before));
					distanceGrid[color1.before][color2.before] = distance;
					distanceGrid[color2.before][color1.before] = distance;
					distanceList[color1.before+"-"+color2.before] = distance;
				}
			}
			return {"grid":distanceGrid,"list":distanceList};
		}
		function exporterCouleurs() {
			var colors = getColors();
			var exporterCouleurs = "";
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				exporterCouleurs += color.before + "\n";
			}
			$("#new-colors-input").val(exporterCouleurs);
		}
		function exportConversion() {
			var colors = getColors();
			var exportConversion = "";
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color && color.before != color.after) {
					exportConversion += color.before + " => " + color.after + "\n";
				}
			}
			$("#export-conversion").val(exportConversion);
		}
		function exportTooCloseColors() {
			var text = "";
			var tbodyGroupListElement = $('#proximity-color-group-list');
			var colorAfter = $(element).find("input.color-input-after").val().toUpperCase();
			tbodyGroupListElement.find("tr").each(function(index, element){
				var replacedColorArray = [];
				$(element).find("li input.color-input-before").each(function(index, element){
					var colorBefore = $(element).val().toUpperCase();
					if( colorAfter != colorBefore ) {
						replacedColorArray.push(colorBefore);
					}
				});
				text += replacedColorArray.join('|') + ' => ' + colorAfter + '\n';
			});
			$("#export-conversion").val(text);
		}
		function copyValTo(element, otherSelector) {
			$(otherSelector).val($(element).val());
		}
		function displayProximityColorGroupList() {
			var colors = getColors();
			colors = colors.sort(function(str1, str2){
				return ( ( str1 == str2 ) ? 0 : ( ( str1 > str2 ) ? 1 : -1 ) );
			});
			var colorDistanceData = buildDistanceLabMatrix(colors);
			console.log(colorDistanceData);
			var seuil = parseFloat( $('#color-matrix-seuil').val() );
			
			{
				var colorDistanceList = [];
				for(var key in colorDistanceData["list"]) {
					colorDistanceList.push(key);
				}
				colorDistanceList = colorDistanceList.sort(function(key1, key2){
					return colorDistanceData["list"][key1] - colorDistanceData["list"][key2];
				});
				//console.log(colorDistanceList);
				//console.log(colorDistanceData["list"]);
				var tbodyGroupListElement = $('#proximity-color-group-list');
				tbodyGroupListElement.empty();
				var colorGroups = [];
				var classedColorSet = new Set();
				
				// Build groups as first pass
				console.log("-----------------Start building groups as first pass");
				for( var colorDistanceIndex in colorDistanceList ) {
					var keys = colorDistanceList[colorDistanceIndex];
					// console.log("keys : " + keys);
					keys = keys.split('-');
					// console.log("keys : " + keys);
					var color1 = keys[0];
					var color2 = keys[1];
					//console.log("====================================== Start couple(color1 : " + color1 + " ; color2 : " + color2 + ")");
					//console.log("color1 : " + color1);
					//console.log("color2 : " + color2);
					// console.log(colorDistanceData["grid"]);
					// console.log(colorDistanceData["grid"][color1]);
					// console.log(colorDistanceData["grid"][color1][color2]);
					var distance = colorDistanceData["grid"][color1][color2];
					//console.log("distance(" + color1 + "," + color2 + ") : " + distance);
					if( 0 < distance && distance <= seuil ) {
						//tbodyGroupListElement.append(getColorLineHtmlTag(color1,color2,distance));
						
						//console.log('colorGroups : ',colorGroups);
						var found = false;
						for( var colorGroupIndex in colorGroups ) {
							var colorGroupSet = colorGroups[colorGroupIndex];
							//console.log("colorGroupSet : ",colorGroupSet);
							if( colorGroupSet.has(color1) || colorGroupSet.has(color2) ) {
								found = true;
								//console.log("found(" + color1 + "," + color2 + ") in ",colorGroupSet);
								
								var isCloseEnoughFromEveryOtherColorInGroup = true;
								for( var colorInSet of colorGroupSet ) {
									var distanceToColorInSet = colorDistanceData["grid"][color1][colorInSet];
									//console.log("color1Loop distanceToColorInSet(" + color1 + " to colorInSet:"+colorInSet+") is ",distanceToColorInSet);
									isCloseEnoughFromEveryOtherColorInGroup = isCloseEnoughFromEveryOtherColorInGroup && ( 0 <= distanceToColorInSet && distanceToColorInSet <= seuil );
									//console.log("color1Loop isCloseEnoughFromEveryOtherColorInGroup(" + color1 + " to colorInSet:"+colorInSet+") is ",isCloseEnoughFromEveryOtherColorInGroup," for ",colorGroupSet);
									if(!isCloseEnoughFromEveryOtherColorInGroup){break;}
								}
								for( var colorInSet of colorGroupSet ) {
									var distanceToColorInSet = colorDistanceData["grid"][color2][colorInSet];
									//console.log("color2Loop distanceToColorInSet(" + color2 + " to colorInSet:"+colorInSet+") is ",distanceToColorInSet);
									isCloseEnoughFromEveryOtherColorInGroup = isCloseEnoughFromEveryOtherColorInGroup && ( 0 <= distanceToColorInSet && distanceToColorInSet <= seuil );
									//console.log("color2Loop isCloseEnoughFromEveryOtherColorInGroup(" + color2 + " to colorInSet:"+colorInSet+") is ",isCloseEnoughFromEveryOtherColorInGroup," for ",colorGroupSet);
									if(!isCloseEnoughFromEveryOtherColorInGroup){break;}
								}
								//console.log("final isCloseEnoughFromEveryOtherColorInGroup (" + color1 + "," + color2 + ") is ",isCloseEnoughFromEveryOtherColorInGroup," for ",colorGroupSet);
								if(isCloseEnoughFromEveryOtherColorInGroup) {
									//console.log("classedColorSet check : ",classedColorSet);
									if(!classedColorSet.has(color1)) {
										colorGroupSet.add(color1);
										classedColorSet.add(color1);
									}
									if(!classedColorSet.has(color2)) {
										colorGroupSet.add(color2);
										classedColorSet.add(color2);
									}
								}
								break;
							}
						}
						if(!found) {
							classedColorSet.add(color1);
							classedColorSet.add(color2);
							colorGroups.push(new Set([color1,color2]));
						}
					}
				}
				
				// Merge groups
				console.log("-----------------Start merging");
				console.log('colorGroups : ',colorGroups);
				var noMergeDone = true;
				var safeCounter = 0;
				var safeCounterLimit = colorGroups.length;
				do{
					var mergedGroups = [];
					var mergedGroupIndexes = new Set();
					for( var colorGroupToMergeIndex = 0 ; colorGroupToMergeIndex < colorGroups.length ; colorGroupToMergeIndex++ ) {
						if(!mergedGroupIndexes.has(colorGroupToMergeIndex)) {
							mergedGroupIndexes.add(colorGroupToMergeIndex);
							var colorGroupSetToMerge = colorGroups[colorGroupToMergeIndex];
							var newMergedSet = new Set(colorGroupSetToMerge);
							for( var colorGroupIndex = colorGroupToMergeIndex + 1 ; colorGroupIndex < colorGroups.length ; colorGroupIndex++ ) {
								if(!mergedGroupIndexes.has(colorGroupIndex)) {
									var colorGroupSet = colorGroups[colorGroupIndex];
									var canMerge = true;
									for( var colorInSetToMerge of newMergedSet ) {
										for( var colorInSet of colorGroupSet ) {
											var distanceToColorInSet = colorDistanceData["grid"][colorInSetToMerge][colorInSet];
											canMerge = canMerge && ( distanceToColorInSet <= seuil );
											if(!canMerge){break;}
										}
									}
									if(canMerge) {
										mergedGroupIndexes.add(colorGroupIndex);
										for (var newColor of colorGroupSet) {
											newMergedSet.add(newColor);
										}
									}
								}
							}
							mergedGroups.push(newMergedSet);
						}
					}
					console.log("colorGroups.length : ",colorGroups.length);
					console.log("mergedGroups.length : ",mergedGroups.length);
					noMergeDone = (colorGroups.length == mergedGroups.length);
					colorGroups = mergedGroups;
					
					safeCounter++;
				} while(!noMergeDone && safeCounter < safeCounterLimit);
				
				// Display groups
				for( var colorGroupIndex in colorGroups ) {
					var colorGroupSet = colorGroups[colorGroupIndex];
					var ulGroupElement = $('<ul/>');
					var remplacementColor = "";
					for( var colorInSet of colorGroupSet ) {
						if( !remplacementColor ) {
							remplacementColor = colorInSet;
						}
						ulGroupElement.append('<li><input type="text" class="color-input-before-code" value="'+colorInSet+'" onchange="copyValTo(this,$(this).parent().find(\'input.color-input-before\'));"/><input type="color" class="color-input-before" value="'+colorInSet+'" onchange="copyValTo(this,$(this).parent().find(\'input.color-input-before-code\'));"/></li>')
					}
					tbodyGroupListElement.append(
						$('<tr/>')
							.append(
								$('<td/>')
								.append(ulGroupElement)
							)
							.append(
								$('<td/>').append('<input type="text" class="color-input-after-code" value="'+remplacementColor+'" onchange="copyValTo(this,$(this).parent().find(\'input.color-input-after\'));"/><input type="color" class="color-input-after" value="'+remplacementColor+'" onchange="copyValTo(this,$(this).parent().find(\'input.color-input-after-code\'));"/>')
							)
					);
				}
			}
			
			displayProximityMatrix(colors, colorDistanceData, seuil);
		}
		function displayProximityMatrix(colors, colorDistanceData, seuil){
			var tbodyElement = $('#proximity-color-distance-matrix');
			tbodyElement.empty();
			{
				var firstLine = $('<tr/>');
				firstLine.append('<th>Colors</th>');
				for( var colorIndex in colors ) {
					var color = colors[colorIndex];
					firstLine.append('<th><input type="color" value="'+color.before+'" /></th>');
				}
				tbodyElement.append(firstLine);
			}
			for( var color1Index in colors ) {
				var color1 = colors[color1Index];
				var line = $('<tr/>');
				line.append('<td><input type="color" value="'+color1.before+'" /></td>');
				for( var color2Index in colors ) {
					var color2 = colors[color2Index];
					var distanceElement = $('<td/>');
					var distance = colorDistanceData["grid"][color1.before][color2.before];
					distanceElement.text(distance.toFixedDown(2));
					if(distance < seuil) {
						distanceElement.css({"color":"red"});
					} else {
						distanceElement.css({"color":"green"});
					}
					line.append(distanceElement);
				}
				tbodyElement.append(line);
			}
		}
		</script>
		<span id='processing-progress'></span>
		<div>
			<textarea id="new-colors-input" ></textarea>
			<button type="button" onclick="exporterCouleurs();">Exporter couleur(s) before</button>
			<button type="button" onclick="ajouterCouleurs();">Ajouter couleur(s)</button>
		</div>
		<div>
			<input id="color-sorting-lab-code" onchange="copyValTo(this,'#color-sorting-lab');" type="text"/>
			<input id="color-sorting-lab" onchange="copyValTo(this,'#color-sorting-lab-code');" type="color"/>
			<button type="button" onclick="sortingColorsLab();">Trier couleur(s) Lab</button>
		</div>
		<div>
			<input id="color-sorting-custom-code" onchange="copyValTo(this,'#color-sorting-custom');" type="text"/>
			<input id="color-sorting-custom" onchange="copyValTo(this,'#color-sorting-code-custom');" type="color"/>
			<button type="button" onclick="sortingColorsCustom();">Trier couleur(s) Custom</button>
		</div>
		<div>
			<textarea id="export-conversion" ></textarea>
			<button type="button" onclick="exportTooCloseColors();">Exporter couleurs proches</button>
			<button type="button" onclick="exportConversion();">Exporter conversion</button>
		</div>
		<div>
			<label for="color-matrix-seuil" >Seuil</label><input id="color-matrix-seuil" type="text" value="2.3"/>
			<button type="button" onclick="displayProximityColorGroupList();">Build distance Matrix</button>
			<div>
				<button type="button" onclick="$(this).parent().find('table').hide();$(this).parent().find('button').show();$(this).hide();">Hide color matrix</button>
				<button type="button" onclick="$(this).parent().find('table').show();$(this).parent().find('button').show();$(this).hide();">Show color matrix</button>
				<table>
					<tbody id="proximity-color-distance-matrix" class="distance-matrix">
					</tbody>
				</table>
			</div>
			<div>
				<button type="button" onclick="$(this).parent().find('table').hide();$(this).parent().find('button').show();$(this).hide();">Hide color groups</button>
				<button type="button" onclick="$(this).parent().find('table').show();$(this).parent().find('button').show();$(this).hide();">Show color groups</button>
				<table>
					<tbody id="proximity-color-group-list">
					</tbody>
				</table>
			</div>
		</div>
		<table>
			<tbody id="color-tbody">
			</tbody>
		</table>
	</body>
</html>
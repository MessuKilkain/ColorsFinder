<!doctype html>
<html>
	<head>
		<script src='w3color.js'></script>
		<meta charset="utf-8"/>
		<style>
td, tr, table {border: solid 1px black;}
td {width: 60px; height: 25px; }
		</style>
		<title>Couleurs</title>
	</head>
	<body>
		<script src="jquery-3.3.1.js"></script>
		<script src="labColor.js" ></script>
		<script src="diff.js" ></script>
		<script>
		function getColors() {
			var colors = [];
			$("#color-tbody tr").each(function(index, element){
				colors.push({
					before:$(element).find(".color-input-before").first().val(),
					after:$(element).find(".color-input-after").first().val()
				});
			});
			return colors;
		}
		function w3colorDistance(colorA, colorB) {
			var aArrayLab = RGBtoLAB(colorA.red, colorA.green, colorA.blue);
			var bArrayLab = RGBtoLAB(colorB.red, colorB.green, colorB.blue);
			return ciede2000(
				{
					L:aArrayLab[0],
					a:aArrayLab[1],
					b:aArrayLab[2]
				},
				{
					L:bArrayLab[0],
					a:bArrayLab[1],
					b:bArrayLab[2]
				}
			);
		}
		function adaptColorBackground(jQueryElement,value){
			console.log(jQueryElement);
			console.log(value);
			if(!value.startsWith("#"))
			{
				value = "#" + value;
			}
			jQueryElement.css("background",value);
		};
		function supprimerLigne(element) {
			$(element).parents('tr').first().remove();
		}
		function getColorLineHtmlTag(colorBefore,colorAfter,distanceToRef) {
			return '<tr><td><button type="button" onclick="supprimerLigne(this);">Supprimer</button></td><td><input type="text" class="color-input-before" value="'+colorBefore+'" onchange="adaptColorBackground($(this).parents(\'tr\').first().find(\'td:nth-child(3)\'),this.value);"/></td><td style="background: '+colorBefore+';" /><td style="background: '+colorAfter+';" /><td><input type="text" class="color-input-after" value="'+colorAfter+'" onchange="adaptColorBackground($(this).parents(\'tr\').first().find(\'td:nth-child(4)\'),this.value);"/></td><td class="distanceToRef">'+distanceToRef+'</td></tr>';
		}
		function ajouterCouleurs(){
			var colors = $("#new-colors-input").val().split("\n");
			var tbody = $("#color-tbody");
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				color = color.trim();
				if(color) {
					tbody.append(getColorLineHtmlTag(color,color,""));
				}
			}
		}
		function sortingColorsLab(){
			var colors = getColors();
			var referenceW3Color = w3color($("#color-sorting-lab").val());
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				color.distanceToRef = w3colorDistance(w3color(color.before), referenceW3Color);
				console.log(color.distanceToRef);
			}
			colors = colors.sort(function(a, b){
				return (a.distanceToRef - b.distanceToRef);
			});
			var tbody = $("#color-tbody");
			tbody.empty();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color) {
					tbody.append(getColorLineHtmlTag(color.before,color.after,color.distanceToRef));
				}
			}
		}
		function sortingColorsCustom(){
			var colors = getColors();
			var referenceW3Color = w3color($("#color-sorting-custom").val());
			var refColorObject = referenceW3Color.toHsl();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				var colorObject = w3color(color.before).toHsl();
				var hDist = Math.abs(colorObject.h-refColorObject.h);
				if( hDist > 180 ) {
					hDist = 360 - hDist;
				}
				color.distanceToRef = Math.pow( Math.pow(hDist,2) + Math.pow((colorObject.s - refColorObject.s)*100,2) + Math.pow((colorObject.l - refColorObject.l)*100,2),0.5);
				console.log(color.distanceToRef);
			}
			colors = colors.sort(function(a, b){
				return (a.distanceToRef - b.distanceToRef);
			});
			var tbody = $("#color-tbody");
			tbody.empty();
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color) {
					tbody.append(getColorLineHtmlTag(color.before,color.after,color.distanceToRef));
				}
			}
		}
		function buildDistanceLabGrid(){
			var colors = getColors();
			var distanceGrid = {};
			for (var colorIndex1 = 0; colorIndex1 < colors.length; colorIndex1++) {
				var color1 = colors[colorIndex1];
				for (var colorIndex2 = colorIndex1; colorIndex2 < colors.length; colorIndex2++) {
					var color2 = colors[colorIndex2];
				}
				//color.distanceToRef = w3colorDistance(w3color(color.before), referenceW3Color);
				console.log(color.distanceToRef);
			}
		}
		function exportConversion() {
			var colors = getColors();
			var exportConversion = "";
			for( var colorIndex in colors ) {
				var color = colors[colorIndex];
				if(color && color.before != color.after) {
					exportConversion += color.before + " => "+ color.after + "\n";
				}
			}
			$("#export-conversion").val(exportConversion);
		}
		function copyValTo(element, otherSelector) {
			$(otherSelector).val($(element).val());
		}
		</script>
		<div>
			<textarea id="new-colors-input" ></textarea>
			<button type="button" onclick="ajouterCouleurs();">Ajouter couleur(s)</button>
		</div>
		<div>
			<input id="color-sorting-lab-code" onchange="copyValTo(this,'#color-sorting-lab');" type="text"/>
			<input id="color-sorting-lab" onchange="copyValTo(this,'#color-sorting-lab-code');" type="color"/>
			<button type="button" onclick="sortingColorsLab();">Trier couleur(s) Lab</button>
		</div>
		<div>
			<input id="color-sorting-custom-code" onchange="copyValTo(this,'#color-sorting-custom');" type="text"/>
			<input id="color-sorting-custom" onchange="copyValTo(this,'#color-sorting-code-custom');" type="color"/>
			<button type="button" onclick="sortingColorsCustom();">Trier couleur(s) Custom</button>
		</div>
		<div>
			<textarea id="export-conversion" ></textarea>
			<button type="button" onclick="exportConversion();">Exporter conversion</button>
		</div>
		<table>
			<tbody id="color-tbody">
			</tbody>
		</table>
	</body>
</html>